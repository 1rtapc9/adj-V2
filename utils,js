export const clientId = 'YOUR_CLIENT_ID_HERE';
export const redirectUri = window.location.origin + window.location.pathname;
export const scopes = 'user-read-private playlist-read-private user-library-read';
export let accessToken = null;

// PKCE Helpers
export async function generateCodeVerifier(){ 
    const array=new Uint32Array(56); crypto.getRandomValues(array); 
    return btoa(String.fromCharCode(...array)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); 
}
export async function sha256(plain){ 
    const encoder=new TextEncoder(); 
    const data=encoder.encode(plain); 
    const hash=await crypto.subtle.digest('SHA-256',data); 
    return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); 
}

// OAuth redirect handling
export async function handleRedirect(){
    const params = new URLSearchParams(window.location.search);
    if(params.has('code')){
        const code = params.get('code');
        const codeVerifier = localStorage.getItem('pkce_verifier');
        const body = new URLSearchParams();
        body.append('grant_type','authorization_code');
        body.append('code', code);
        body.append('redirect_uri', redirectUri);
        body.append('client_id', clientId);
        body.append('code_verifier', codeVerifier);
        const resp = await fetch('https://accounts.spotify.com/api/token',{
            method:'POST',body,headers:{'Content-Type':'application/x-www-form-urlencoded'}
        });
        const data = await resp.json();
        accessToken = data.access_token;
        history.pushState("", document.title, redirectUri);
        alert('Logged in successfully!');
    }
}

// Spotify Search API
export async function searchSpotify(query){
    if(!accessToken){ alert('Please log in first'); return []; }
    const type='track,playlist,album,show,episode,artist';
    const resp = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=${type}&limit=12`,{
        headers:{Authorization:'Bearer '+accessToken}
    });
    const data = await resp.json();
    const items = [];
    ['tracks','playlists','albums','shows','episodes','artists'].forEach(k=>{
        if(data[k] && data[k].items) data[k].items.forEach(it=>{
            items.push({
                type: k.slice(0,-1),
                id: it.id,
                title: it.name || '',
                sub: it.artists ? it.artists.map(a=>a.name).join(', ') : it.owner?.display_name || it.publisher || '',
                image: it.images?.[0]?.url || it.album?.images?.[0]?.url || ''
            });
        });
    });
    return items;
}
